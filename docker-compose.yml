services:

  freshrss:
    image: freshrss/freshrss
    container_name: freshrss
    hostname: freshrss
    restart: unless-stopped
    environment:
      - TZ=America/Sao_Paulo
      - CRON_MIN=1,31
    volumes:
      - ./data/freshrss:/var/www/FreshRSS/data
      - ./extensions:/var/www/FreshRSS/extensions
    ports:
      - "8080:80"

  rss-bridge:
    image: rssbridge/rss-bridge:latest
    container_name: rss-bridge
    restart: unless-stopped
    volumes:
      - ./data/rss-bridge/config:/config
    environment:
      - TZ=America/Sao_Paulo

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5679:5678" # TEMPORÁRIO (removeremos no passo 2)
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - TZ=America/Sao_Paulo
      - GENERIC_TIMEZONE=America/Sao_Paulo

      # Core
      - N8N_HOST=n8n
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5679/
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true

      # Database
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8npassword

      # Python Runner
      - N8N_CODE_PYTHON_ENABLED=true
      - N8N_CODE_PYTHON_BINARY=/opt/venv/bin/python3

      # Segurança / Execução de código
      - N8N_PERMIT_ONLY_CREDENTIAL_NODES=false
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_RESTRICT_FILE_ACCESS_TO=/data_midia
      - N8N_LOG_LEVEL=debug
      - N8N_LOG_LEVEL=debug
      - N8N_DIAGNOSTICS_ENABLED=true

      # Telegram Notification
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

      # API Keys Explícitas (para garantir acesso via $env)
      - GOOGLE_CUSTOM_SEARCH_KEY=${GOOGLE_CUSTOM_SEARCH_KEY}
      - GOOGLE_CUSTOM_SEARCH_CX=${GOOGLE_CUSTOM_SEARCH_CX}
      - SERPER_API_KEY=${SERPER_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - PEXELS_API_KEY=${PEXELS_API_KEY}
      - PIXABAY_API_KEY=${PIXABAY_API_KEY}

      # Diretórios
      - N8N_USER_FOLDER=/home/node/.n8n

    volumes:
      - ./data/n8n:/home/node/.n8n
      - ./data/midia:/data_midia
      - c:/Users/Usuario/Desktop/meu-freshrss/Docs:/Docs
      - ./data/n8n_config.json:/home/node/.n8n/config.json:ro

    depends_on:
      - postgres
      - ollama

  python_service:
    build: ./python_service
    container_name: python_service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # ffmpeg is installed via apt as /usr/bin/ffmpeg in the CUDA runtime image.
      - IMAGEIO_FFMPEG_EXE=/usr/bin/ffmpeg
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,video
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    gpus: all
    ports:
      - "8000:8000"
    volumes:
      - ./data/midia:/data_midia
      - ./python_service/app:/app/app
      - ./python_service/tests:/app/tests
      - ./python_service/auth_youtube.py:/app/auth_youtube.py
      - ./.env:/app/.env
      - ./data/cookies_tiktok.txt:/app/cookies_tiktok.txt
      - ./python_service/client_secret.json:/app/client_secret.json
      - ./python_service/token.json:/app/token.json
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [ gpu ]

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=n8n
      - POSTGRES_PASSWORD=n8npassword
      - POSTGRES_DB=n8n
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
      - TZ=America/Sao_Paulo

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ./data/ollama:/root/.ollama
    environment:
      - TZ=America/Sao_Paulo

  kokoro:
    image: ghcr.io/remsky/kokoro-fastapi-cpu:latest
    container_name: kokoro
    restart: unless-stopped
    ports:
      - "11435:8880"
    environment:
      - TZ=America/Sao_Paulo

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    ports:
      - "8888:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=America/Sao_Paulo

  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    restart: unless-stopped
    ports:
      - "8081:8080"
    volumes:
      - ./data/searxng:/etc/searxng
    environment:
      - BASE_URL=http://localhost:8081/

#   a1111:
#     # User pediu: ghcr.io/abdbarho/stable-diffusion-webui-docker:latest
#     # Vou usar a do user, mas com command override para garantir API.
#     image: ghcr.io/abdbarho/stable-diffusion-webui-docker:universal
#     container_name: a1111
#     restart: unless-stopped
#     ports:
#       - "7861:7861"
#     environment:
#       - CLI_ARGS=--api --listen --port 7861 --no-half --nowebui
#       - TZ=America/Sao_Paulo
#     volumes:
#       - ./data/sd-data:/data
